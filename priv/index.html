<html>
<head>
<script src="/static/jquery-2.1.4.min.js"></script>
<script src="/static/d3.min.js"></script>
<style>
#gameSelect { display: none }
#table { display: none }
#leaveBtn { display: none }
#startBtn { display: none }
</style>
</head>
<body>
<div id="conPanel">
  Nick name: <input type="text" id="nickname">
  <button id="conServer">Connect to server</button>
</div>
<div id="gameSelect">
  <button id="createGame">Create game</button>
  <button id="listGames">List games</button>
  <div id="tables">
  </div>
</div>
<div id="table">
  <button id="sitBtn">Sit</button>
  <button id="leaveBtn">Leave</button>
  <button id="startBtn">Start</button>

  <div id="container"></div>
  
  <div class="seat">_</div>
  <div class="seat">_</div>
  <div class="seat">_</div>
  <div class="seat">_</div>
  <div class="seat">_</div>
  <div class="seat">_</div>

  <div id="pots">
  </div>
  <div id="communityCards">
  </div>

  <div id="options">
  </div>
</div>
<div id="log"></div>
<script src="/static/game-d3.js"></script>
<script>

var $conPanel = $('#conPanel');
var $nickName = $('#nickname');
var $conServerBtn = $('#conServer');
var $log = $('#log');
var $gameSelect = $('#gameSelect');
var $table = $('#table');
var $pots = $('#pots');
var $communityCards = $('#communityCards');
var $createGameBtn = $('#createGame');
var $listGamesBtn = $('#listGames');
var $tables = $('#tables');
var $sitBtn = $('#sitBtn');
var $leaveBtn = $('#leaveBtn');
var $startBtn = $('#startBtn');
var $options = $('#options');

var websocket;

$conServerBtn.click(function() {
  connect();
});

$createGameBtn.click(function() {
  websocket.send('create_table');
});

$listGamesBtn.click(function() {
  websocket.send('list_tables');
});

$sitBtn.click(function() {
  websocket.send('sit');
});

$gameSelect.on('click', '.joinBtn', function() {
  websocket.send('join_table ' + this.getAttribute('data'));
});

$startBtn.click(function() {
  websocket.send('start_game');
});

$options.on('click', '.actionBtn', function() {
  websocket.send('take_turn ' + this.getAttribute('data'));
});

function connect() {
  var nn = $nickName.val();
  websocket = new WebSocket('ws://' + window.location.host + '/player_ws?nickname=' + encodeURIComponent(nn));
  websocket.onopen = function(e) { onOpen(e) };
  websocket.onclose = function(e) { onClose(e) };
  websocket.onmessage = function(e) { onMessage(e) };
  websocket.onerror = function(e) { onError(e) };
};

function log(msg) {
  $log.prepend('<p>' + msg + '</p>');
};

function onOpen(e) {
  log('connected');
  $conPanel.hide();
  $gameSelect.show();
}

function onClose(e) {
  log('closed');
  $conPanel.show();
  $gameSelect.hide();
  $table.hide();
}

function onMessage(e) {
  console.log('got message: ', e.data);

  var s = e.data.split('|', 2);
  if (s.length == 2) {
    var header = s[0];
    var content = JSON.parse(s[1]);
    
    switch(header) {
      case 'create_table':
        handle_create_table(content);
        break;
      case 'join_table':
        handle_create_table(content);
        update_game(content);
        break;
      case 'sit':
        handle_sit(content);
        break;
      case 'list_tables':
        handle_list_tables(content);
        break;
      case 'game_started':
        handle_game_started(content);
        break;
      case 'update_game':
        update_game(content);
        break;
      case 'signal_turn':
        handle_signal_turn(content);
        break;
      case 'take_turn':
        handle_take_turn(content);
        break;
      default:
        log('unhandled reply: ' + e.data);
    }
  } else {
    log('unhandled reply: ' + e.data);
  }
}

function handle_take_turn(res) {
  if (res['error']) {
    log('error: ' + res['error']);
  } else {
    $options.empty();
  }
}

function handle_signal_turn(options) {
  for (var i = 0; i < options.length; i++) {
    var option = options[i];
    $options.append('<button class="actionBtn" data="'+option+'">'+option+'</button>');
  }
}

function handle_game_started(res) {
  $startBtn.hide();
}

function handle_sit(res) {
  update_game(res);
  $sitBtn.hide();
  $leaveBtn.show();
  $startBtn.show();
}

function update_game(res) {
  if (res['status'] != 'ok') return;

  var game = res['game'];
  var seats = game['seats'];
  for (var i = 0; i < seats.length; i++) {
    var seat = seats[i];
    var $seat = $('.seat:nth('+i+')');
    if (seat['player']) {
      $seat.html('<span>Money: '+seat['money']+'</span>, <span>Bet:'+seat['bet']+'</span>');
      for (var j = 0; j < seat['cards'].length; j++) {
        $seat.append(card_to_html(seat['cards'][j]));
      }
    } else {
      $seat.html('_');
    }
  }

  var pots = game['pots'];
  $pots.empty();
  for (var i = 0; i < pots.length; i++) {
    var pot = pots[i];
    $pots.append('<div>Pot: '+pot['money']+'</div>');
  }

  var cc = game['community_cards'];
  $communityCards.empty();
  for (var i = 0; i < cc.length; i++) {
    var c = cc[i];
    $communityCards.append(card_to_html(c));
  }

  draw(res['game']);
}

function card_to_html(c) {
  if (c == 'unknown') {
    return '<span>unknown</span>';
  } else {
    return '<span>'+c['rank']+' '+c['suit']+'</span>';
  }
}

function handle_create_table(res) {
  if (res['status'] == 'ok') {
    $gameSelect.hide();
    $table.show();
  }
}

function handle_list_tables(tables) {
  $tables.empty();
  for (var i = 0; i < tables.length; i++) {
    var id = tables[i];
    $tables.append('<div>'+id+' <button class="joinBtn" data="'+id+'">Join</button></div>');
  }
}

function onError(e) {
  log('error: ' + e.data);
}

</script>
</body>
</html>
